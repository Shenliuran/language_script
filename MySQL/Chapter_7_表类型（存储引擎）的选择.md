# 第七章 表类型（存储引擎）的选择

## 概述

+ 插件式存储引擎是 MySQL 数据库最重要的特性之一，用户可以根据应用的需要选择如何存储和索引数据、是否使用事务等
+ 在创建新表的时候，可以通过增加 ENGINE 关键字设置新建表的存储引擎
+ 修改数据表引擎：`ALTER TABLE tablename ENGINE = newEngine`
+ 在启动MySQL服务的时候使用`--init-file`选项，把`INSERT INTO...`、`SELECT`或`LOAD DATA INFILE`这样的语句放入这个文件中，就可以在服务启动时从稳定的数据源装载表

## 各种存储引擎的特性

+ 常用存储引擎的对比

>特点|MyISAM|InnoDB|MEMORY|MERGE|NDB
>|:--|:-----|:----|:-----|:----|:--|
>存储限制|有|64TB|有|没有|有
>事务安全||支持
>锁机制|表锁|行锁|表锁|表锁|行锁
>B 树索引|支持|支持|支持|支持|支持
>哈希索引|||支持||支持
>全文索引|支持
>集群索引||支持
>数据缓存||支持|支持||支持
>索引缓存|支持|支持|支持|支持|支持
>数据可压缩|支持
>空间使用|低|高|N/A|低|低
>内存使用|低|高|中等|低|高
>批量插入的速度|高|低|高|高|高
>支持外键|支持

### MyISAM

+ MyISAM是MySQL的默认存储引擎
+ 每个M有ISAM在磁盘上存储成3个文件，其文件名都和表明相同，扩展名分别：
    1. `.frm`：存储表定义
    2. `.MYD`：MYData，存储数据
    3. `.MYI`：MYIndex，存储索引
+ 数据文件和索引文件可以放在不同的目录，平均分布IO，获得更快的速度
+ 要指定索引文件和数据文件的路径，需要在创建表的时候通过 `DATA DIRECTORY` 和 `INDEX DIRECTORY` 语句指定。文件路径需要时 **绝对路径**，并且 **具有访问权限**
+ MyISAM 类型的表可能会损坏，原因可能是多种多样的，**损坏后的表可能不能访问**，会提示需要修复或者访问后返回错误的结果
+ 插入记录后面的空格都被去掉了，前面的空格保留
+ 定期执行 `OPTIMIZE TABLE` 语句或 `myisamchk -r` 命令来改善性能，

### InnoDB

+ InnoDB 存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全
+ 自动增长列
    1. 自动增长列可以手工插入，但是插入的值如果是 **空或者 0**，则 **实际插入的将是自动增长后的值**
    2. 可以通过`ALTER TABLE tablename AUTO_INCREMENT n`语句强制设置自动增长列的初识值
    3. 对于 InnoDB 表，自动增长列必须是索引，如果是组合索引，也必须是组合索引的第一列
+ 外键约束
    1. MySQL 支持外键的存储引擎 **只有** InnoDB，在创建外键的时候，要求 **父表必须有对应的索引**，子表在创建外键的时候也会 **自动创建对应的索引**
    2. 在创建索引的时候，可以指定在 *删除*、*更新* 父表时，对子表进行的相应操作，包括`restrict`（限制）、`cascade`（级联）、`set null`和`no action`
        1. restrict和no action相同：是限制在子表有关联记录的情况下父表不能更新
        2. cascade：表示父表在更新或者删除时，更新或者删除子表对应的记录
        3. set null：表示父表在更新或者删除的时候，子表的对应字段被set null
        4. 选择后两种方式要谨慎，可能会因为错误的操作导致数据丢失
    3. 当某个表被其他表创建了外键参照，那么该表的对应索引或者主键禁止被删除
    4. 在导入多个表的数据时，如果需要忽略表之前的导入顺序，可以暂时关闭外键的检查
    5. 同样，在执行 `LOAD DATA` 和 `ALTER TABLE` 操作的时候，可以通过暂时关闭外键约束来加快处理的速度，关闭的命令是`SET FOREIGN_KEY_CHECKS = 0;`，执行完成之后，通过执行`SET FOREIGN_KEY_CHECKS = 1;`句改回原状态
+ 储存方式
    1. InnoDB 存储表和索引有以下两种方式：
        1. 使用 **共享表空间存储**，这种方式创建的表的表结构保存在`.frm` 文件中，数据和索引保存在 `innodb_data_home_dir` 和 `innodb_data_file_path` 定义的表空间中，可以是 **多个文件**
        2. 使用 **多表空间存储**，这种方式创建的表的表结构仍然保存在`.frm` 文件中，但是每个表的数据和索引 **单独保存** 在`.ibd` 中。如果是个分区表，则每个分区对应单独的.ibd文件，文件名是 **表名+分区名**
    2. 要使用多表空间的存储方式，需要设置参数 `innodb_file_per_table`，并 **重新启动服务** 后才可以生效
    3. 多表空间的数据 **文件没有大小限制**，**不需要设置初始大小**，也 **不需要设置文件的最大限制**、**扩展大小等参数**

### MEMORY

+ MEMORY 存储引擎使用存在内存中的内容来创建表，**数据是放在内存** 中的
+ 每个 MEMORY 表只实际对应一个磁盘文件，格式是.frm
+ 默认使用 HASH 索引，但是一旦服务关闭，表中的数据就会丢失掉
+ 给 MEMORY 表创建索引的时候，可以指定使用 `HASH` 索引还是 `BTREE` 索引：`CREATE INDEX mem_hash USING HASH ON tab_memory(city_id);`
+ 给 MEMORY 表创建索引的时候，可以指定使用 HASH 索引还是 BTREE 索引
+ 当不再需要 MEMORY表的内容之时，要释放被MEMORY 表使用的内存，应该执行 `DELETE FROM` 或 `TRUNCATE TABLE`，或者整个地删除表（使用 `DROP TABLE` 操作）
+ MEMORY 类型的存储引擎主要用在那些 **内容变化不频繁的代码表**，或者作为 **统计操作的中间结果表**，便于高效地对中间结果进行分析并得到最终的统计结果

### MERGE

+ MERGE 存储引擎是一组 MyISAM 表的组合，这些 MyISAM 表必须结构完全相同，MERGE表 **本身并没有数据**，对 MERGE 类型的表可以进行查询、更新、删除的操作，这些操作实际上是对内部的实际的MyISAM表进行的
+ 对于 MERGE 类型表的插入操作，是通过`INSERT_METHOD`子句定义插入的表，可以有 3 个不同的值，使用 `FIRST` 或 `LAST` 值使得插入操作被相应地作用在第一或最后一个表上，不定义这个子句或者定义为 `NO`，表示不能对这个 MERGE 表执行插入操作
+ 可以对 MERGE 表进行 `DROP` 操作，这个操作只是 **删除MERGE的定义**，**对内部的表没有任何的影响**
+ 可以通过修改.MRG 文件来修改 MERGE 表，但是修改后要通过 FLUSH TABLES 刷新

## 如何选择合适的存储引擎

+ 常用存储引擎的适用环境
    >数据库类型|特点|适应场景
    >|:------|:------|:-----|
    >MyISAM|以读操作和插入操作为主</br>只用很少的更新和删除操作</br>对事物的完整性、并发性要求不高|web、数据仓库和其他应用环境下
    >InnoDB|事务处理应用程序，支持外键</br>对事物的完整性有比较高的要求</br>在并发条件下要求数据的一致性</br>很多的更新和删除操作|计费系统、财务系统等对数据准确性要求比较高的系统
    >MEMORY|快速定位记录和其他类似数据的环境下，可提供极快的访问|通常用于更新不太频繁的小表，用以快速得到访问结果
    >MERGE|优点在于可以突破对单个 MyISAM 表大小的限制，并且通过将不同的表分布在多个磁盘上|数据仓储等VLD B环境
